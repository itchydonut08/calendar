<!DOCTYPE html>
<html>
<head>
  <title>GIS Calendar Integration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { padding: 10px 20px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Google Calendar via GIS</h1>
  <div id="g_id_onload"
       data-client_id="530875477700-s2ebm4u8qcm0dhgq78kk16r6loaab0t2.apps.googleusercontent.com"
       data-auto_prompt="false"
       data-callback="handleCredentialResponse">
  </div>

  <div class="g_id_signin"
       data-type="standard"
       data-shape="pill"
       data-theme="outline"
       data-text="signin_with"
       data-size="large">
  </div>

  <button onclick="signOut()">Sign Out</button>
  <div id="events"></div>

  <script>
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
    const CLIENT_ID = '530875477700-s2ebm4u8qcm0dhgq78kk16r6loaab0t2.apps.googleusercontent.com';

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: '', // Not needed
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
      });
      gapiInited = true;
    }

    window.onload = () => {
      gapiLoaded();

      tokenClient = google.accounts.oauth2.initTokenClient({
  client_id: CLIENT_ID,
  scope: SCOPES,
  callback: async (tokenResponse) => {
    if (tokenResponse.error) {
      console.error('Token error', tokenResponse);
      return;
    }
    localStorage.setItem('google_token', tokenResponse.access_token);
    
    // âœ… REDIRECT AFTER SUCCESSFUL LOGIN
    window.location.href = 'calendar.html';
  }
});


      const existingToken = localStorage.getItem('google_token');
      if (existingToken) {
        gapi.auth.setToken({access_token: existingToken});
        listEvents();
      }
    };

    function handleCredentialResponse(response) {
      tokenClient.requestAccessToken();
    }

    async function listEvents() {
      try {
        const res = await gapi.client.calendar.events.list({
          calendarId: 'primary',
          timeMin: (new Date()).toISOString(),
          showDeleted: false,
          singleEvents: true,
          maxResults: 5,
          orderBy: 'startTime'
        });

        const events = res.result.items;
        const output = document.getElementById('events');
        output.innerHTML = "<h3>Upcoming Events:</h3>";
        if (!events.length) {
          output.innerHTML += "<p>No events found.</p>";
        } else {
          events.forEach(e => {
            output.innerHTML += `<p><strong>${e.summary}</strong> - ${e.start.dateTime || e.start.date}</p>`;
          });
        }
      } catch (err) {
        console.error(err);
        localStorage.removeItem('google_token');
      }
    }

    function signOut() {
      localStorage.removeItem('google_token');
      location.reload();
    }
  </script>
</body>
</html>
