<!DOCTYPE html>
<html>
<head>
  <title>Send from Gmail</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const CLIENT_ID = "530875477700-s2ebm4u8qcm0dhgq78kk16r6loaab0t2.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/gmail.send";

    let tokenClient;

    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) return alert("Auth error.");
          localStorage.setItem("gmail_token", tokenResponse.access_token);
          alert("Signed in. Ready to send email.");
        }
      });

      document.getElementById("signin").onclick = () => tokenClient.requestAccessToken();
      document.getElementById("sendBtn").onclick = sendEmail;
    };

    function base64UrlEncode(str) {
      return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    async function sendEmail() {
      const token = localStorage.getItem("gmail_token");
      if (!token) return alert("Please sign in first.");

      const to = document.getElementById("to").value;
      const subject = "3-Month Calendar";
      const message = "Here is your calendar PDF attachment (not included in this example).";

      const mimeMessage =
        `To: ${to}\r\n` +
        `Subject: ${subject}\r\n` +
        `Content-Type: text/plain; charset=UTF-8\r\n\r\n` +
        `${message}`;

      const raw = base64UrlEncode(mimeMessage);

      gapi.load("client", async () => {
        await gapi.client.init({
          apiKey: "", // not needed for OAuth
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"],
        });

        gapi.client.setToken({ access_token: token });

        gapi.client.gmail.users.messages.send({
          userId: "me",
          resource: { raw: raw }
        }).then(() => {
          alert("Email sent!");
        }).catch(err => {
          console.error(err);
          alert("Failed to send email.");
        });
      });
    }
  </script>
</head>
<body>
  <h2>Send Email From Your Gmail</h2>
  <button id="signin">Sign in with Google</button><br><br>
  <input type="email" id="to" placeholder="Recipient email" /><br>
  <button id="sendBtn">Send Email</button>
</body>
</html>

